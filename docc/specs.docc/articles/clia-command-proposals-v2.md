# Feature Specification: CLIA Command Proposals (V2)

**Feature Branch**: `[clia-command-proposals-v2]`  
**Created**: 2026-01-07  
**Status**: Draft  
**Input**: User description: "use @Generable as the core response schema"

## What Changed from V1

- Moved from free-form response text + implicit parsing to schema-constrained output.
- Added `responseText` alongside `proposedCommands` as a single `@Generable` response payload.
- Clarified that the model must emit only schema-conforming fields (no ad-hoc extraction).
- Added guidance for malformed/partial payloads as an explicit edge case.
- P0 keeps the existing response shape; richer command details come later.

## P0 Scope

- User-entered `!` commands continue to execute as-is.
- CLIA chat responses use the `@Generable` model and the existing response shape.
- Do not add new command detail fields in P0.
- Add a P0 analysis comparing FoundationModels vs AnyLanguageModel for schema-constrained outputs:
  <doc:foundationmodels-vs-anylanguagemodel-p0-analysis>

## CommonAI Changes (P0)

- Add a response format/config type (schema-aware) to CommonAI.
- Add overloads on `CommonAIModel.complete` and `CommonAIChat.send` to accept the response format.
- Add a structured payload representation (JSON) to `CAIPart`/`CAIMessage` or introduce a parallel
  structured message type.
- Apple provider: use `@Generable` response output and decode into the existing response shape.
- Google provider: map to JSON schema response config and decode into the existing response shape.
- OpenAI provider: use schema/response format if supported; otherwise surface a “schema unsupported”
  error for Generable requests.

## Parity Requirements (Generative-ai-swift)

When evaluating AnyLanguageModel or changing CommonAI wiring, preserve these capabilities:

- JSON schema responses (`responseMIMEType`, `responseSchema`).
- Tool calling.
- Streaming responses.
- Token counting.
- Provider-specific configuration (for example, Gemini thinking modes and server tools).

## User Scenarios & Testing *(Mandatory)*

### User Story 1 - Generable Command Proposals (Priority: P1)

As an operator, I want CLIA responses to include proposed commands using `@Generable` so I can
approve or edit them without typing `!`.

**Why this priority**: This is the core behavior change and unblocks automated command proposals.

**Independent Test**: Ask for a task that needs a shell command and verify the response includes
`proposedCommands` generated by the `@Generable` schema, using the existing response shape.

**Acceptance Scenarios**:

1. **Given** a task that needs shell execution, **When** CLIA responds,
   **Then** the response includes one or more proposed commands shaped by the `@Generable` schema.
2. **Given** a proposed command, **When** the user approves it,
   **Then** the command executes via CommonProcess streaming.

---

### User Story 2 - Schema-constrained Responses (Priority: P2)

As an implementer, I want the response schema to be generated via `@Generable` so the model only
emits the expected command proposal fields.

**Why this priority**: Ensures predictable model output and schema alignment.

**Independent Test**: Build the response model and confirm the generated schema includes
`proposedCommands` and its nested fields.

**Acceptance Scenarios**:

1. **Given** the response model annotated with `@Generable`, **When** the schema is generated,
   **Then** `proposedCommands` is present and typed.
2. **Given** the schema, **When** the model responds, **Then** the output conforms without
   fallback parsing or ad-hoc extraction.

---

### Edge Cases

- What happens when no command is needed?
- How does the system handle invalid or unsafe proposed commands?
- How does the system represent multiple proposed commands in a single response?
- How does the system handle a malformed or partial `@Generable` payload?

## Requirements *(Mandatory)*

### Functional Requirements

- **FR-001**: Response model MUST include a `proposedCommands` field when commands are suggested.
- **FR-002**: `proposedCommands` MUST be represented in the `@Generable` schema output.
- **FR-003**: Each proposed command MUST include the command string and a rationale.
- **FR-004**: Each proposed command MUST indicate whether approval is required.
- **FR-005**: Responses with no commands MUST omit or empty `proposedCommands`.
- **FR-006**: The model MUST be instructed to emit only schema-conforming `@Generable` output.
- **FR-007**: P0 MUST keep the existing response shape; no new command detail fields yet.

### Key Entities *(Include If Feature Involves Data)*

- **ProposedCommand**: command string, arguments, rationale, approvalRequired, optional risk or
  policy tags.

#### ProposedCommand Shape (Draft)

```json
{
  "command": "rg",
  "arguments": ["-n", "sosumi", "."],
  "rationale": "Find references to the sosumi tool in the mono workspace.",
  "approvalRequired": true,
  "policyTags": ["shell", "read-only"]
}
```

#### Generable Response Shape (Draft)

```json
{
  "responseText": "I can scan the repo for sosumi references. Want me to run it?",
  "proposedCommands": [
    {
      "command": "rg",
      "arguments": ["-n", "sosumi", "."],
      "rationale": "Find references to the sosumi tool in the mono workspace.",
      "approvalRequired": true,
      "policyTags": ["shell", "read-only"]
    }
  ]
}
```

## Success Criteria *(Mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of command suggestions are represented in `proposedCommands`.
- **SC-002**: Schema generation includes `proposedCommands` without manual patching.
